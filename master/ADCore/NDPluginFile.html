<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>NDPluginFile &#8212; areaDetector 3-4-95-g7700506 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../_static/lbco_32.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="NDFileJPEG" href="NDFileJPEG.html" />
    <link rel="prev" title="NDPluginFFT" href="NDPluginFFT.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          areaDetector</a>
        <span class="navbar-text navbar-version pull-left"><b>3-4</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../release.html">Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../release.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release.html#versions">Versions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../readme.html">Readme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install_guide.html">Install Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../install_guide.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install_guide.html#licsense">Licsense</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install_guide.html#installing-and-building-from-source-code">Installing and Building from Source Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install_guide.html#downloading-and-installing-areadetector-source-code">Downloading and Installing areaDetector Source Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install_guide.html#installing-pre-built-binary-versions-of-areadetector">Installing Pre-Built Binary Versions of areaDetector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install_guide.html#display-managers">Display Managers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install_guide.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install_guide.html#running-the-ioc-application">Running the IOC Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install_guide.html#image-viewers">Image Viewers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../detectors.html">Supported Detectors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../detectors.html#commuinity-supported-detectors">Commuinity Supported Detectors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../detectors.html#areadetector-camera-drivers-supplied-by-3rd-parties">areaDetector camera drivers supplied by 3rd parties</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../legacy_versions.html">Legacy Versions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../legacy_versions.html#required-modules">Required Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../legacy_versions.html#installation-and-building">Installation and Building</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../user_guide.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="arch.html">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="asynPortDriver.html">asynPortDriver</a></li>
<li class="toctree-l2"><a class="reference internal" href="NDArray.html">NDArray</a></li>
<li class="toctree-l2"><a class="reference internal" href="../detector_drivers.html">Detector Drivers</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="plugins.html">areaDetector Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="medm.html">MEDM screens</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ADViewers/ad_viewers.html">areaDetector Viewers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../acknowledgements.html">Acknowledgements and licenses</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../doxygen.html">Source Code Documentation</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">NDPluginFile</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#null-file-plugin">Null file plugin</a></li>
<li><a class="reference internal" href="#performance">Performance</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="NDPluginFFT.html" title="Previous Chapter: NDPluginFFT"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; NDPluginFFT</span>
    </a>
  </li>
  <li>
    <a href="NDFileJPEG.html" title="Next Chapter: NDFileJPEG"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">NDFileJPEG &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/ADCore/NDPluginFile.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="ndpluginfile">
<h1><a class="toc-backref" href="#id2">NDPluginFile</a><a class="headerlink" href="#ndpluginfile" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">author:</th><td class="field-body">Mark Rivers, University of Chicago</td>
</tr>
</tbody>
</table>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#ndpluginfile" id="id2">NDPluginFile</a><ul>
<li><a class="reference internal" href="#overview" id="id3">Overview</a></li>
<li><a class="reference internal" href="#null-file-plugin" id="id4">Null file plugin</a></li>
<li><a class="reference internal" href="#performance" id="id5">Performance</a></li>
</ul>
</li>
</ul>
</div>
<div class="toctree-wrapper compound">
<p class="caption"><span class="caption-text">File Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="NDFileJPEG.html">NDFileJPEG</a></li>
<li class="toctree-l1"><a class="reference internal" href="NDFileTIFF.html">NDFileTIFF</a></li>
<li class="toctree-l1"><a class="reference internal" href="NDFileHDF5.html">NDFileHDF5</a></li>
<li class="toctree-l1"><a class="reference internal" href="NDFileNexus.html">NDFileNexus</a></li>
<li class="toctree-l1"><a class="reference internal" href="NDFileMagick.html">NDFileMagick</a></li>
<li class="toctree-l1"><a class="reference internal" href="NDFileNetCDF.html">NDFileNetCDF</a></li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id3">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>NDPluginFile is a base class from which actual file plugins are derived.
There are currently file plugins for JPEG, TIFF, netCDF, Nexus, HDF5,
and GraphicsMagick. The GraphicsMagick plugin can write a large number
of formats, including JPEG, TIFF, PNG, PDF and many others.</p>
<p>NDPluginFile inherits from NDPluginDriver. The <a class="reference external" href="../areaDetectorDoxygenHTML/class_n_d_plugin_file.html">NDPluginFile class
documentation</a>
describes this class in detail. This class is designed to simplify the
task of supporting a new file format. A derived class to support a new
file format will typically need to implement only the pure virtual
functions <code class="docutils literal notranslate"><span class="pre">openFile()</span></code>, <code class="docutils literal notranslate"><span class="pre">readFile()</span></code>, <code class="docutils literal notranslate"><span class="pre">writeFile()</span></code>, and
<code class="docutils literal notranslate"><span class="pre">closeFile()</span></code>. Note that none of the current file plugins actually
support the <code class="docutils literal notranslate"><span class="pre">readFile()</span></code> function yet, but this is planned for future
releases.</p>
<p>The NDArray callback data can be written to disk in 1 of 3 modes:</p>
<ol class="arabic simple">
<li>Single mode. In this mode each NDArray callback results in a separate
disk file.</li>
<li>Capture mode. In this mode a memory buffer is allocated before saving
begins. Callback arrays are placed into this buffer, and when capture
stops the file is written to disk. This mode limits the number of
frames that can be saved, because they all must fit in a memory
buffer. It is the fastest mode, with the least probability of
dropping arrays, because no disk I/O is required while capture is in
progress.</li>
<li>Stream mode. In this mode the data are written to a single disk file
for those file formats that support multiple arrays per file (netCDF,
NeXus and HDF5). Each frame is appended to the file without closing
it. It is intermediate in speed between single mode and capture mode,
but unlike capture mode it is not limited by available memory in the
number of arrays that can be saved. For file formats that do not
support multiple arrays per file (e.g. JPEG, TIFF) this mode is
really the same as Single mode, except that one can specify a total
number of files to save before stopping.</li>
</ol>
<p>The CreateDirectory record controls whether directories are created if
they don’t exist. If it is zero (default), no directories are created.
If it is negative, then the absolute value is the maximum of directories
that will be created (i.e. -1 will create a maximum of one directory to
complete the path, -2 will create a maximum of 2 directories). If it is
positive, then at least that many directories in the path must exist
(i.e. a value of 1 will create all directories below the root directory
and 2 will not create a directory in the root directory).</p>
<p>If value of the LazyOpen record is “No” (0) then at least one array with
the same datatype, array size, and attributes must have been collected
by the driver (and/or plugins) from which the file saving plugin is
getting its data <strong>before</strong> capture or stream mode file saving is
started. This is required so that the openFile() function can know the
dimensions and datatype of the arrays. If LazyOpen is “Yes” and the mode
is Stream then the file open if deferred until the first array callback
after streaming is started. This will slow down the saving of the first
file.</p>
<p>NDPluginFile supports all of the file saving parameters defined in
<a class="reference external" href="areaDetectorDoc.html#asynNDArrayDriver">asynNDArrayDriver</a>, e.g.
NDFilePath, NDFileName, etc. Thus, the same interface that is used for
saving files directly in a driver is used for this plugin.</p>
<p>The base class will delete the “original” file that the driver created
for that array if the following are all true:</p>
<ol class="arabic">
<li><p class="first">The DeleteDriverFile record is “Yes”.</p>
</li>
<li><p class="first">The file plugin has successfully written a new file.</p>
</li>
<li><p class="first">The array contains an attribute called “DriverFileName” that contains
the full file name of the original file. The driver attributes XML
file should contain a line like the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;Attribute name=&quot;DriverFileName&quot; type=&quot;PARAM&quot; source=&quot;FULL_FILE_NAME&quot; datatype=&quot;string&quot; description=&quot;Driver file name&quot;/&gt;
</pre></div>
</div>
</li>
</ol>
<p>The file saving plugins normally determine the name of the file from the
FileName and FileNumber records. However, it is possible to have these
values come instead from attributes in the array passed to the callback.
The following 3 special attributes are used:</p>
<ol class="arabic simple">
<li>FilePluginFileName: This attribute contains the file name.</li>
<li>FilePluginFileNumber - This attribute contains the file number.</li>
<li>FilePluginDestination - If this attribute contains the string “all”
or the name of the asyn port for this plugin (e.g. FileTIFF1) then
the plugin will write the array to a file. If this attribute has any
other value then the plugin will ignore this array, and not write a
file.</li>
</ol>
<p>Having the file information come from the array allows the driver to
control which plugin saves a particular array. For example, there may be
two file writing plugins active; the first saves the flat field files
for a tomography experiment, and the second saves the normal
projections. These plugins each stream data to a separate file. The
driver knows which files are flat fields and which are normal
projections, and adds the appropriate attributes to control which plugin
saves each array. This would not be possible using a single plugin and
EPICS PVs to switch the file, because of the problem of frames being
buffered in the plugin queue.</p>
<p>Normally files in Stream and Capture mode are automatically closed when
the requested number of frames have been collected, or when the Capture
record is set back to 0. It is also possible to use an NDArray attribute
to close the file. If the NDArray contains an attribute named
FilePluginClose and the attribute value is non-zero then the current
file will be closed.</p>
</div>
<div class="section" id="null-file-plugin">
<span id="null"></span><h2><a class="toc-backref" href="#id4">Null file plugin</a><a class="headerlink" href="#null-file-plugin" title="Permalink to this headline">¶</a></h2>
<p>NDFileNull inherits from NDPluginFile. This is a dummy file writer,
which does not actually write anything. Its main purpose is to delete
original driver files (DeleteDriverFile record) without writing the data
to disk. For example, if the Pilatus is being used simply for alignment
or testing one might want to display the images but then immediately
delete the files that the Pilatus had created. This plugin allows one to
do this, since it always reports success in “writing” the file, so the
NDPluginFile base class will deleted the driver file if all the
conditions outlined above are met.</p>
<p>The <a class="reference external" href="../areaDetectorDoxygenHTML/class_n_d_file_null.html">NDFileNull class
documentation</a>describes
this class in detail.</p>
<p>The NDFileNull plugin is created with the NDFileNullConfigure command,
either from C/C++ or from the EPICS IOC shell.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>NDFileNullConfigure (const char *portName, int queueSize, int blockingCallbacks,
                     const char *NDArrayPort, int NDArrayAddr, size_t maxMemory,
                     int priority, int stackSize)
</pre></div>
</div>
</div>
<div class="section" id="performance">
<span id="id1"></span><h2><a class="toc-backref" href="#id5">Performance</a><a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h2>
<p>Performance measurements were made on the Linux and Windows systems
shown in the following table.</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Model</th>
<th class="head">Operating
system</th>
<th class="head">CPU</th>
<th class="head">RAM</th>
<th class="head">Disk</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Dell
Precision
T7500</td>
<td>Windows 7
64-bit</td>
<td>Two
quad-core
Xeon X5647,
2.93 GHz (8
cores
total)</td>
<td>96 GB</td>
<td>Two 500 GB
15K RPM SAS
disks RAID
0</td>
</tr>
<tr class="row-odd"><td>Penguin
Relion 1751
Server</td>
<td>Linux,
Fedora Core
14 64-bit</td>
<td>Two
quad-core
Xeon E5630,
2.53 GHz (8
cores
total)</td>
<td>12 GB</td>
<td>Three 300
GB 15K RPM
SAS disks
No RAID</td>
</tr>
</tbody>
</table>
<p>The tests were performed under the following conditions:</p>
<ul class="simple">
<li>Simulation detector with a single small peak in Peaks mode. The
driver was running in Continuous mode with AcquireTime=0, and
AcquirePeriod=0, to achieve maximum frame rate. Both Windows and
Linux were able to generate about 1500 frames/sec, which was faster
than any of the file plugins could write, so they were always
dropping frames.</li>
<li>1024 x 1024 8-bit images, so each image was 1 MB.</li>
<li>File plugins operating in non-blocking mode.</li>
<li>Files were written to a local disk.</li>
<li>For the file plugins that cannot save multiple images per file (JPEG,
TIFF, Magick), tests were done only in Stream mode, which allows
specifying the total number of files to write. For the drivers that
can save multiple images per file (netCDF, Nexus, HDF5) tests were
done first in Stream mode which saved 5000 images to a single 5GB
file. Tests were then done in Single mode. In this mode it is not
possible to tell the file plugin to save exactly 5000 frames. Instead
the simulation driver was put in Multiple mode with NumImages=5000.
Thus the driver generated 5000 frames, but the plugin saved fewer
than 5000 because it was dropping frames. The file rate was
calculated as the number of frames actually written divided by the
elapsed time.</li>
<li>Note that the amount of data written to the files (5GB) was less than
the amound of RAM on each system. It is thus possible that files are
being cached in RAM, and that for more frames the I/O rate would
drop. This is almost certainly true for the HDF5 file in stream mode
on Windows, which has a data rate over 1GB/s.</li>
</ul>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="11%" />
<col width="36%" />
<col width="34%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">File plugin</th>
<th class="head">Mode</th>
<th class="head">Windows (frames/s = MB/s)</th>
<th class="head">Linux (frames/s = MB/s)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>JPEG</td>
<td>Stream</td>
<td>79.1</td>
<td>68.4</td>
</tr>
<tr class="row-odd"><td>TIFF</td>
<td>Stream</td>
<td>259.9</td>
<td>186.4</td>
</tr>
<tr class="row-even"><td>Magick, TIFF</td>
<td>Stream</td>
<td>55.7</td>
<td>39.0</td>
</tr>
<tr class="row-odd"><td>netCDF</td>
<td>Stream</td>
<td>204.3</td>
<td>185.0</td>
</tr>
<tr class="row-even"><td>netCDF</td>
<td>Single</td>
<td>133.7</td>
<td>179.1</td>
</tr>
<tr class="row-odd"><td>Nexus</td>
<td>Stream</td>
<td>192.3</td>
<td>193.4</td>
</tr>
<tr class="row-even"><td>Nexus</td>
<td>Single</td>
<td>106.3</td>
<td>145.6</td>
</tr>
<tr class="row-odd"><td>HDF5</td>
<td>Stream</td>
<td>1113.5</td>
<td>192.0</td>
</tr>
<tr class="row-even"><td>HDF5</td>
<td>Single</td>
<td>139.7</td>
<td>108.6</td>
</tr>
</tbody>
</table>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Mark Rivers.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>